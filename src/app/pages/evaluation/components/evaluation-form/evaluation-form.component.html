<div
  class="dark:bg-bunker-900/50 dark:border-bunker-800 mx-auto mt-5 mb-15 max-w-5xl rounded-lg border border-gray-200 bg-white p-4 shadow-xs">
  <!-- Survey Header -->
  <div
    class="bg-primary-100/50 dark:bg-primary-700 flex flex-col gap-1 rounded-lg p-4 text-center">
    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
      Encuesta de {{ campaign().name }}
    </h2>
    <p class="italic">{{ campaign().objective }}</p>
    <p class="text-primary-800 dark:text-gray-300">
      <span>{{ campaign().channel | titlecase }} •</span>
      <span>
        {{ campaign().date_start | date: 'dd/MM/yyyy' }}
        -
        {{ campaign().date_end | date: 'dd/MM/yyyy' }}
      </span>
    </p>
  </div>
  <form [formGroup]="evaluationForm">
    @if (!disabled()) {
      <div class="px-2 pt-6">
        <p-fileupload
          name="media"
          [progress]="50"
          accept="video/*"
          [customUpload]="true"
          [multiple]="false"
          [showUploadButton]="true"
          [auto]="false"
          [maxFileSize]="5368709120"
          chooseLabel="Seleccionar archivo"
          uploadLabel="Subir archivo"
          cancelLabel="Cancelar"
          (onSelect)="onMediaUpload($event)"
          (onClear)="onRemoveMedia()"
          (onRemove)="onRemoveMedia()"
          (uploadHandler)="onMediaSubmit()">
          <ng-template #content let-files>
            @if (selectMediaFile() !== null) {
              <p-progressbar
                [value]="uploadProgress()"
                [showValue]="false"
                class="w-full"
                styleClass="md:w-20rem h-1 w-full md:ml-auto" />
              <span class="whitespace-nowrap">
                {{ uploadedSize() }} / {{ totalSize() }}
              </span>
            }
          </ng-template>
          <ng-template #empty>
            <div>No se ha seleccionado ningún archivo</div>
          </ng-template>
        </p-fileupload>
      </div>
    } @else {
      <!-- Reproductor de video -->
      <media-controller class="mt-5 h-full w-full">
        <hls-video
          class="flex items-center justify-center"
          [src]="evaluation()?.video?.url"
          slot="media"
          poster="../images/video-cover.webp"
          crossorigin
          muted
          preload="none"></hls-video>

        <media-loading-indicator
          slot="centered-chrome"
          noautohide=""></media-loading-indicator>

        <media-rendition-menu
          hidden
          id="menu1"
          anchor="menu-button1"></media-rendition-menu>

        <media-control-bar>
          <media-play-button class="px-2"></media-play-button>
          <media-seek-backward-button
            class="px-2"
            seekoffset="5"></media-seek-backward-button>
          <media-seek-forward-button
            class="px-2"
            seekoffset="15"></media-seek-forward-button>
          <media-mute-button class="px-2"></media-mute-button>
          <media-volume-range class="px-2"></media-volume-range>
          <media-time-display class="px-2"></media-time-display>
          <media-time-range class="px-2"></media-time-range>
          <media-duration-display class="px-2"></media-duration-display>
          <media-playback-rate-button
            id="menu-button1"
            invoketarget="menu1"
            class="px-2"></media-playback-rate-button>
          <media-rendition-menu-button
            class="px-2"></media-rendition-menu-button>
          <media-fullscreen-button class="px-2"></media-fullscreen-button>
        </media-control-bar>
      </media-controller>
    }
    <div class="mt-2 grid gap-4 px-2 py-4 md:grid-cols-2">
      <div class="md:col-span-2">
        @if (isEditing() && selectMediaFile() !== null) {
          <app-input-text
            label="Titulo del adjunto"
            formControlName="title"
            icon="lucideType" />
        } @else if (!isEditing() || disabled()) {
          <app-input-text
            label="Titulo del adjunto"
            formControlName="title"
            icon="lucideType" />
        }
      </div>
      @if (byZone()) {
        <app-input-location
          [formGroup]="evaluationForm"
          controlNameState="location" />
      }
      <app-input-text
        label="Nombre del Colaborador"
        formControlName="evaluated_collaborator"
        icon="lucideUser" />
    </div>
    <div class="mt-4 flex flex-col gap-4" formArrayName="evaluation_answers">
      @for (section of campaign().survey?.sections; track $index) {
        <div
          class="border-primary-300 dark:border-primary-700 overflow-hidden rounded-lg border">
          <!-- Header -->
          <div
            class="bg-primary-100/50 dark:bg-primary-800 flex justify-between p-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
              {{ section.name }}
            </h2>
            <p>({{ section.maximum_score + ' ' + 'puntos' }})</p>
          </div>
          <!-- Section Aspects -->
          <div class="flex flex-col gap-5 p-5">
            @for (
              aspect of section.aspects;
              track $index;
              let aspectIndex = $index
            ) {
              <div
                [formGroup]="getEvaluationAspectById(aspect.id)"
                class="dark:bg-bunker-900 dark:border-bunker-800 rounded-lg border border-gray-200 bg-gray-100/40 p-4">
                <h3 class="font-semibold">{{ aspect.description }}</h3>
                <div class="mt-2 grid gap-4 lg:grid-cols-2">
                  <div class="flex flex-col gap-1">
                    <label class="text-sm font-semibold" for="comment">
                      Observaciones
                    </label>
                    <textarea
                      pTextarea
                      rows="1"
                      [autoResize]="true"
                      formControlName="comment">
                    </textarea>
                  </div>
                  <div class="flex flex-col gap-1">
                    @switch (aspect.type) {
                      @case ('number') {
                        <label
                          class="text-sm font-semibold"
                          [for]="aspect.id + '-score'">
                          Puntaje (0-{{ aspect.maximum_score }})
                        </label>
                        <p-inputnumber
                          [inputId]="aspect.id + '-score'"
                          [showButtons]="true"
                          buttonLayout="horizontal"
                          spinnerMode="horizontal"
                          [min]="0"
                          [max]="aspect.maximum_score"
                          class="w-full text-center"
                          formControlName="value_number">
                          <ng-template #incrementbuttonicon>
                            <ng-icon name="lucidePlus" size="20" />
                          </ng-template>
                          <ng-template #decrementbuttonicon>
                            <ng-icon name="lucideMinus" size="20" />
                          </ng-template>
                        </p-inputnumber>
                      }
                      @case ('boolean') {
                        <label
                          class="text-sm font-semibold"
                          [for]="aspect.id + '-bool'">
                          Cumple
                        </label>
                        <p-selectbutton
                          [options]="[
                            { label: 'Sí', value: true },
                            { label: 'No', value: false },
                          ]"
                          optionValue="value"
                          formControlName="value_boolean"
                          class="w-full" />
                      }
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
    <div class="mt-5 flex justify-between gap-5">
      @if (isLoading()) {
        <app-spinner />
      } @else {
        <div class="flex items-center gap-5">
          <app-button-secondary
            title="Volver"
            icon="lucideArrowLeft"
            (event)="goBack()" />
          @if (disabled()) {
            <app-evaluation-change-status [evaluation_id]="evaluation()!.id" />
          }
        </div>
        @if (isEditing() && !disabled()) {
          <app-button-primary
            title="Editar Evaluación"
            icon="lucideSave"
            [disabled]="!this.evaluationForm.valid"
            (event)="onEdit()" />
        } @else if (!isEditing()) {
          <app-button-primary
            title="Registrar Evaluación"
            icon="lucideSave"
            [disabled]="!this.evaluationForm.valid || !this.uploadComplete()"
            (event)="onSubmit()" />
        }
      }
    </div>
  </form>
</div>
