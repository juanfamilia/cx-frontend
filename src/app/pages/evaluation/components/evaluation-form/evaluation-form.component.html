<div
  class="dark:bg-bunker-900/50 dark:border-bunker-800 mx-auto mt-5 mb-15 max-w-5xl rounded-lg border border-gray-200 bg-white p-4 shadow-xs">
  <!-- Survey Header -->
  <div
    class="bg-primary-100/50 dark:bg-primary-700 flex flex-col gap-1 rounded-lg p-4 text-center">
    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
      Encuesta de {{ campaign().name }}
    </h2>
    <p class="italic">{{ campaign().objective }}</p>
    <p class="text-primary-800 dark:text-gray-300">
      <span>{{ campaign().channel | titlecase }} •</span>
      <span>
        {{ campaign().date_start | date: 'dd/MM/yyyy' }}
        -
        {{ campaign().date_end | date: 'dd/MM/yyyy' }}
      </span>
    </p>
  </div>
  <form [formGroup]="evaluationForm">
    <div class="px-2 pt-6">
      <p-fileupload
        name="media"
        accept="image/*,video/*"
        customUpload="true"
        (onSelect)="onMediaUpload($event)"
        (onRemove)="selectMediaFile.set(null)"
        [multiple]="false"
        [showUploadButton]="false"
        [auto]="false"
        [maxFileSize]="5368709120"
        chooseLabel="Seleccionar archivo"
        cancelLabel="Cancelar">
        <ng-template #empty>
          <div>No se ha seleccionado ningún archivo</div>
        </ng-template>
      </p-fileupload>
    </div>
    <div class="mt-2 grid gap-4 px-2 py-4 md:grid-cols-2">
      <div class="md:col-span-2">
        @if (isEditing() && selectMediaFile() !== null) {
          <app-input-text
            label="Titulo del adjunto"
            formControlName="title"
            icon="lucideType" />
        } @else if (!isEditing()) {
          <app-input-text
            label="Titulo del adjunto"
            formControlName="title"
            icon="lucideType" />
        }
      </div>
      @if (byZone()) {
        <app-input-location
          [formGroup]="evaluationForm"
          controlNameState="location" />
      }
      <app-input-text
        label="Nombre del Colaborador"
        formControlName="evaluated_collaborator"
        icon="lucideUser" />
    </div>
    <div class="mt-4 flex flex-col gap-4" formArrayName="evaluation_answers">
      @for (section of campaign().survey?.sections; track $index) {
        <div
          class="border-primary-300 dark:border-primary-700 overflow-hidden rounded-lg border">
          <!-- Header -->
          <div
            class="bg-primary-100/50 dark:bg-primary-800 flex justify-between p-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
              {{ section.name }}
            </h2>
            <p>({{ section.maximum_score + ' ' + 'puntos' }})</p>
          </div>
          <!-- Section Aspects -->
          <div class="flex flex-col gap-5 p-5">
            @for (
              aspect of section.aspects;
              track $index;
              let aspectIndex = $index
            ) {
              <div
                [formGroup]="getEvaluationAspectById(aspect.id)"
                class="dark:bg-bunker-900 dark:border-bunker-800 rounded-lg border border-gray-200 bg-gray-100/40 p-4">
                <h3 class="font-semibold">{{ aspect.description }}</h3>
                <div class="mt-2 grid gap-4 lg:grid-cols-2">
                  <div class="flex flex-col gap-1">
                    <label class="text-sm font-semibold" for="comment">
                      Observaciones
                    </label>
                    <textarea
                      pTextarea
                      rows="1"
                      [autoResize]="true"
                      formControlName="comment">
                    </textarea>
                  </div>
                  <div class="flex flex-col gap-1">
                    @switch (aspect.type) {
                      @case ('number') {
                        <label
                          class="text-sm font-semibold"
                          [for]="aspect.id + '-score'">
                          Puntaje (0-{{ aspect.maximum_score }})
                        </label>
                        <p-inputnumber
                          [inputId]="aspect.id + '-score'"
                          [showButtons]="true"
                          buttonLayout="horizontal"
                          spinnerMode="horizontal"
                          [min]="0"
                          [max]="aspect.maximum_score"
                          class="w-full text-center"
                          formControlName="value_number">
                          <ng-template #incrementbuttonicon>
                            <ng-icon name="lucidePlus" size="20" />
                          </ng-template>
                          <ng-template #decrementbuttonicon>
                            <ng-icon name="lucideMinus" size="20" />
                          </ng-template>
                        </p-inputnumber>
                      }
                      @case ('boolean') {
                        <label
                          class="text-sm font-semibold"
                          [for]="aspect.id + '-bool'">
                          Cumple
                        </label>
                        <p-selectbutton
                          [options]="[
                            { label: 'Sí', value: true },
                            { label: 'No', value: false },
                          ]"
                          optionValue="value"
                          formControlName="value_boolean"
                          class="w-full" />
                      }
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
    <div class="mt-5 flex justify-between gap-5">
      @if (isLoading()) {
        <p>Cargando...</p>
      } @else {
        @if (isEditing()) {
          <app-button-primary
            title="Editar Evaluación"
            icon="lucideSave"
            [disabled]="!this.evaluationForm.valid"
            (event)="onEdit()" />
        } @else {
          <app-button-primary
            title="Registrar Evaluación"
            icon="lucideSave"
            [disabled]="!this.evaluationForm.valid || !this.selectMediaFile()"
            (event)="onSubmit()" />
        }
      }
    </div>
  </form>
</div>
