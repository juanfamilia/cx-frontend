<!-- Floating Button -->
<div class="fixed top-4 right-4 z-50">
  <button
    pTooltip="An치lisis IA"
    tooltipPosition="left"
    class="text-primary-500 dark:bg-bunker-900 dark:hover:bg-bunker-950/30 dark:border-bunker-800/75 flex cursor-pointer items-center justify-center rounded-full border border-gray-300 bg-white p-2 transition-colors duration-200 ease-in-out hover:bg-gray-300"
    (click)="showDialog()">
    <ng-icon name="lucideSparkles" size="20" />
  </button>
</div>

<!-- Dialog -->
<p-dialog
  header="游뱄 An치lisis (IA)"
  [modal]="true"
  [(visible)]="visible"
  styleClass="w-full max-w-5xl">
  <div class="mb-4 flex flex-col gap-4 text-gray-800 dark:text-gray-300">
    @if (isLoading()) {
      <div class="flex w-full flex-col items-center justify-center">
        <app-spinner />
        <h3>Cargando an치lisis...</h3>
      </div>
    } @else {
      @if (analysis()) {
        <!-- Tabs -->
        <p-tabs value="0" class="flex h-full flex-col">
          <!-- Tabs sticky -->
          <div class="dark:bg-bunker-900 sticky top-0 z-40 bg-white">
            <p-tablist>
              <p-tab value="0">Vista Ejecutiva</p-tab>
              <p-tab value="1">Vista Operativa</p-tab>
            </p-tablist>
          </div>

          <p-tabpanels>
            <!-- TAB 1 -->
            <p-tabpanel value="0">
              <markdown
                [data]="analysis()?.executive_view"
                class="prose dark:prose-invert max-w-none"></markdown>
            </p-tabpanel>

            <!-- TAB 2 -->
            <p-tabpanel value="1">
              <div class="relative">
                <!-- Copy button -->
                <button
                  pTooltip="Copiar JSON"
                  class="absolute top-2 right-2 text-gray-400 hover:text-white"
                  (click)="copyJson()">
                  <ng-icon name="lucideClipboard" size="18" />
                </button>

                <!-- JSON viewer -->
                <ngx-json-viewer
                  [json]="parsedJson"
                  [expanded]="false"
                  class="theme-dracula max-h-[60vh] overflow-auto rounded-xl p-4 text-sm">
                </ngx-json-viewer>

                <!-- Expand all -->
                <button
                  class="text-primary-400 mt-2 text-xs hover:underline"
                  (click)="expandAll()">
                  Expandir
                </button>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      } @else {
        <p class="italic">
          El an치lisis est치 en proceso o no se encuentra disponible...
        </p>
      }
    }
  </div>

  <!-- Footer -->
  <div class="mt-4 flex items-center justify-between">
    <small class="text-xs text-gray-500 italic dark:text-gray-400">
      Generado: {{ analysis()?.created_at | date: 'yyyy-MM-dd HH:mm' }}
    </small>

    <div class="flex gap-2">
      <p-button label="Exportar CSV" icon="pi pi-file" (click)="exportCsv()" />
      <p-button
        label="Exportar PDF"
        icon="pi pi-file-pdf"
        (click)="exportPdf()" />
      <p-button label="Cerrar" severity="secondary" (click)="hiddenDialog()" />
    </div>
  </div>
</p-dialog>
