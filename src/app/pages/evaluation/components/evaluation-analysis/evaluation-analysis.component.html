<!-- Button -->
<div class="fixed top-4 right-4 z-50">
  <button
    pTooltip="An√°lisis IA"
    tooltipPosition="left"
    class="text-primary-500 dark:bg-bunker-900 dark:hover:bg-bunker-950/30 dark:border-bunker-800/75 flex cursor-pointer items-center justify-center rounded-full border border-gray-300 bg-white p-2 transition-colors duration-200 ease-in-out hover:bg-gray-300"
    (click)="showDialog()">
    <ng-icon name="lucideSparkles" size="20" />
  </button>
</div>

<!-- Dialog -->
<p-dialog
  header="ü§ñ An√°lisis (IA)"
  [modal]="true"
  [(visible)]="visible"
  draggable="false"
  styleClass="w-full max-w-6xl h-[90vh] bg-bunker-950">
  <!-- Header con timestamp y acciones -->
  <div
    class="dark:bg-bunker-900/50 sticky top-0 z-10 -mt-4 mb-4 border-b border-gray-200 bg-white px-4 py-3 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="font-mono text-xs text-gray-500 dark:text-gray-400">
          Generado: {{ getTimestamp() }}
        </span>
        @if (analysis.value()) {
          <span
            class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800 dark:bg-green-900/20 dark:text-green-400">
            <div
              class="mr-1.5 h-1.5 w-1.5 animate-pulse rounded-full bg-green-500"></div>
            Actualizado
          </span>
        }
      </div>
      <div class="flex items-center gap-2">
        @if (analysis.value()) {
          <button
            class="inline-flex items-center rounded-md bg-gray-100 px-3 py-1.5 text-xs font-medium text-gray-700 transition-colors hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
            (click)="exportToPDF()"
            pTooltip="Exportar a PDF"
            tooltipPosition="bottom">
            <ng-icon name="lucideDownload" size="14" class="mr-1" />
            PDF
          </button>
          <button
            class="inline-flex items-center rounded-md bg-gray-100 px-3 py-1.5 text-xs font-medium text-gray-700 transition-colors hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
            (click)="exportToCSV()"
            pTooltip="Exportar datos a CSV"
            tooltipPosition="bottom">
            <ng-icon name="lucideTable" size="14" class="mr-1" />
            CSV
          </button>
        }
      </div>
    </div>
  </div>

  <div>
    <!-- Loading spinner -->
    @if (analysis.isLoading()) {
      <div class="flex h-96 w-full flex-col items-center justify-center">
        <app-spinner />
        <h3 class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">
          Cargando an√°lisis...
        </h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Esto puede tomar unos momentos
        </p>
      </div>
    } @else {
      @if (analysis.value()) {
        <!-- Tabs fijos -->
        <div class="flex flex-col">
          <p-tabs value="0" class="flex h-full flex-col">
            <div
              class="sticky top-0 z-10 border-b border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800">
              <p-tablist class="border-b-0">
                <p-tab value="0">
                  <div class="flex items-center gap-2">
                    <ng-icon name="lucideChartBar" size="16" />
                    Vista Ejecutiva
                  </div>
                </p-tab>
                <p-tab value="1">
                  <div class="flex items-center gap-2">
                    <ng-icon name="lucideCode" size="16" />
                    Vista Operativa
                  </div>
                </p-tab>
              </p-tablist>
            </div>

            <p-tabpanels class="flex-1 overflow-hidden">
              <!-- TAB 1 - Vista Ejecutiva -->
              <p-tabpanel value="0" class="h-full p-0">
                <div
                  class="scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent h-full overflow-y-auto px-1 py-4">
                  <div class="max-w-none">
                    <markdown
                      [data]="analysis.value()?.executive_view"
                      class="prose prose-sm dark:prose-invert prose-headings:text-gray-900 dark:prose-headings:text-gray-100 prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-li:text-gray-700 dark:prose-li:text-gray-300 max-w-none">
                    </markdown>
                  </div>
                </div>
              </p-tabpanel>

              <!-- TAB 2 - Vista Operativa -->
              <p-tabpanel value="1" class="h-full p-0">
                <div class="flex h-full flex-col">
                  <!-- Header del JSON con bot√≥n de copiar -->
                  <div
                    class="sticky top-0 z-5 border-b border-gray-200 bg-gray-50 px-4 py-3 dark:border-gray-700 dark:bg-gray-800/50">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <h4
                          class="text-sm font-medium text-gray-900 dark:text-gray-100">
                          Datos Operativos
                        </h4>
                        <span
                          class="font-mono text-xs text-gray-500 dark:text-gray-400"
                          >JSON</span
                        >
                      </div>
                      <div class="flex items-center gap-2">
                        <button
                          class="inline-flex items-center rounded bg-blue-600 px-2 py-1 text-xs font-medium text-white transition-colors hover:bg-blue-700"
                          (click)="copyJsonToClipboard()"
                          pTooltip="Copiar JSON completo"
                          tooltipPosition="bottom">
                          <ng-icon
                            [name]="
                              copySuccess() ? 'lucideCheck' : 'lucideCopy'
                            "
                            size="14"
                            class="mr-1" />
                          {{ copySuccess() ? 'Copiado!' : 'Copiar' }}
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- JSON Content -->
                  <div
                    class="scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent flex-1 overflow-y-auto">
                    <pre
                      class="h-full overflow-x-auto bg-gray-900 p-6 font-mono text-sm leading-relaxed text-gray-100"
                      [style.font-family]="
                        'JetBrains Mono, Fira Code, Monaco, Consolas, monospace'
                      "
                      #jsonContainer>
                      {{ getFormattedJson() }}
                      </pre
                    >
                  </div>
                </div>
              </p-tabpanel>
            </p-tabpanels>
          </p-tabs>
        </div>
      } @else {
        <div class="flex h-96 flex-col items-center justify-center text-center">
          <ng-icon
            name="lucideCircleAlert"
            size="48"
            class="mb-4 text-gray-400" />
          <p class="mb-2 text-lg font-medium text-gray-900 dark:text-gray-100">
            An√°lisis no disponible
          </p>
          <p class="mb-6 text-sm text-gray-500 dark:text-gray-400">
            El an√°lisis est√° en proceso o no se encuentra disponible en este
            momento
          </p>
        </div>
      }
    }
  </div>

  <div
    class="flex-shrink-0 border-t border-gray-200 bg-white px-2 py-4 dark:border-gray-700 dark:bg-gray-800">
    <div class="flex items-center justify-between">
      <div class="text-xs text-gray-500 dark:text-gray-400">
        @if (analysis.value()) {
          An√°lisis completado ‚Ä¢ {{ getAnalysisSize() }} caracteres
        }
      </div>
      <p-button
        label="Cerrar"
        severity="secondary"
        (click)="hiddenDialog()"
        size="small" />
    </div>
  </div>
</p-dialog>
